<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Raptor Recommendations</title>
  <link rel="stylesheet" href="style.css"> 
  <link rel="stylesheet" href="https://www.lightningdesignsystem.com/assets/styles/salesforce-lightning-design-system.min.css">
</head>
<body class="slds-scope">
  <div id="block-settings" class="slds-p-around_medium slds-box slds-theme_default">
    <h1 class="slds-text-heading_large" style="padding-bottom: 12px;">Raptor Manual Products</h1>
   <h2 class="slds-text-heading_medium">Settings</h2>
    <!-- Number of Rows -->
    <div class="slds-form-element">
      <label class="slds-form-element__label" for="rows">Number of Rows:</label>
      <div class="slds-form-element__control">
        <input type="range" id="rows" class="slds-range" min="1" max="5" value="1" style="width: 100%;">
      </div>
      <div class="slds-text-body_regular">
        <span id="rows-value">1</span>
      </div>
    </div>

    <!-- Layout Selection -->
    <div class="slds-form-element">
      <label class="slds-form-element__label" for="layout">Layout:</label>
      <div class="slds-form-element__control">
        <select id="layout" class="slds-select">
          <option value="produktbillede">Billede</option>
          <option value="produktnavn">Billede + Navn</option>
          <option value="produktnavnpris">Billede + Navn + Pris</option>
        </select>
      </div>
    </div>

    <!-- Feed Tracking -->
    <div class="slds-form-element">
      <label class="slds-form-element__label" for="feedtracking">Feed tracking:</label>
      <div class="slds-form-element__control">
        <input type="text" id="feedtracking" class="slds-input">
      </div>
    </div>

  

    <!-- Product ID Inputs -->
    <h2 class="slds-text-heading_medium slds-m-top_large">Insert product ID's</h2>
    <div id="conditional-ids">
      <!-- ID Fields (conditionally displayed) -->
      <div id="product-group1" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid1" class="slds-text-title">ID1:</label><input type="text" id="productid1" class="slds-input"></div>
      <div id="product-group2" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid2" class="slds-text-title">ID2:</label><input type="text" id="productid2" class="slds-input"></div>
      <div id="product-group3" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid3" class="slds-text-title">ID3:</label><input type="text" id="productid3" class="slds-input"></div>
      <div id="product-group4" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid4" class="slds-text-title">ID4:</label><input type="text" id="productid4" class="slds-input"></div>
      <div id="product-group5" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid5" class="slds-text-title">ID5:</label><input type="text" id="productid5" class="slds-input"></div>
      <div id="product-group6" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid6" class="slds-text-title">ID6:</label><input type="text" id="productid6" class="slds-input"></div>
      <div id="product-group7" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid7" class="slds-text-title">ID7:</label><input type="text" id="productid7" class="slds-input"></div>
      <div id="product-group8" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid8" class="slds-text-title">ID8:</label><input type="text" id="productid8" class="slds-input"></div>
      <div id="product-group9" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid9" class="slds-text-title">ID9:</label><input type="text" id="productid9" class="slds-input"></div>
      <div id="product-group10" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid10" class="slds-text-title">ID10:</label><input type="text" id="productid10" class="slds-input"></div>
    </div>

    <!-- Always Visible ID Fields (ID11 to ID18) -->
    <div id="product-group11" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid11" class="slds-text-title">Fallback1:</label><input type="text" id="productid11" class="slds-input"></div>
    <div id="product-group12" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid12" class="slds-text-title">Fallback2:</label><input type="text" id="productid12" class="slds-input"></div>
    <div id="product-group13" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid13" class="slds-text-title">Fallback3:</label><input type="text" id="productid13" class="slds-input"></div>
    <div id="product-group14" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid14" class="slds-text-title">Fallback4:</label><input type="text" id="productid14" class="slds-input"></div>
    <div id="product-group15" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid15" class="slds-text-title">Fallback5:</label><input type="text" id="productid15" class="slds-input"></div>
    <div id="product-group16" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid16" class="slds-text-title">Fallback6:</label><input type="text" id="productid16" class="slds-input"></div>
    <div id="product-group17" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid17" class="slds-text-title">Fallback7:</label><input type="text" id="productid17" class="slds-input"></div>
    <div id="product-group18" class="id-group slds-p-around_xx-small slds-grid slds-grid_vertical-align-center"><label for="productid18" class="slds-text-title">Fallback8:</label><input type="text" id="productid18" class="slds-input"></div>

 
  </div>
  
  <script src="blocksdk.js"></script>

  <script>




    
    const sdk = new window.sfdc.BlockSDK();

    sdk.getData(function(data) {
      document.getElementById('rows').value = data.rows || 1;
      document.getElementById('rows-value').textContent = data.rows || 1;
      document.getElementById('layout').value = data.layout || 'produktnavn';
      document.getElementById('feedtracking').value = data.feedtracking || '';
    
      if (data.productIds) {
          data.productIds.forEach((id, index) => {
              const input = document.getElementById(`productid${index + 1}`);
              if (input) input.value = id;
          });
      }
    
      updateIDFields(); // Ensure correct ID fields are displayed
    });
    
    const rowsInput = document.getElementById('rows');
    const rowsValue = document.getElementById('rows-value');
    const conditionalIds = document.getElementById('conditional-ids').children;
    
    // Initialize the layoutInput and feedtrackingInput variables
    const layoutInput = document.getElementById('layout');
    const feedtrackingInput = document.getElementById('feedtracking');
    
    // Add event listeners for slider (to update rows and ID fields dynamically)
    rowsInput.addEventListener('input', () => {
      rowsValue.textContent = rowsInput.value;
      updateIDFields(); // Update ID fields whenever rows change
      handleGenerate(); // Trigger the same logic as the button click when rows change
    });
    
    // Add event listeners for other inputs to trigger logic whenever they change
    layoutInput.addEventListener('change', handleGenerate);
    feedtrackingInput.addEventListener('input', handleGenerate);
    
    // Add event listeners to all product ID inputs to trigger handleGenerate
    for (let i = 1; i <= 18; i++) {
      const productInput = document.getElementById(`productid${i}`);
      if (productInput) {
        productInput.addEventListener('input', handleGenerate);
      }
    }





  // Function to update displayed ID fields based on rows
  function updateIDFields() {
    const rows = parseInt(rowsInput.value);
    rowsValue.textContent = rows;

    // Loop through the first 10 ID fields (ID1-ID10)
    for (let i = 1; i <= 10; i++) {
        const group = document.getElementById(`product-group${i}`);

        if (i <= rows * 2) {
            group.style.display = 'flex'; // Show the entire div
        } else {
            group.style.display = 'none'; // Hide the entire div
        }
    }

    // Ensure the last 8 ID fields (ID11-ID18) are always visible
    for (let i = 11; i <= 18; i++) {
        const group = document.getElementById(`product-group${i}`);
        group.style.display = 'flex';
    }
}



    // Update when rows input changes
    rowsInput.addEventListener('input', updateIDFields);
    
    
    // Function to handle the generation of settings based on user inputs
    function handleGenerate() {
      const rows = rowsInput.value;
      const layout = layoutInput.value;
      const feedtracking = feedtrackingInput.value;
      const productIds = [];
      for (let i = 1; i <= 18; i++) {
        productIds.push(document.getElementById(`productid${i}`).value);
      }

      //const images = [];
      let html = '';
    html += `%%[`;

    html += `SET @prodRows = "${rows}" `;
    html += `SET @layout = "${layout}" `;
    html += `SET @feedtracking ="${feedtracking}" `;
 
    html += `SET @ID1 = "${productIds[0]}" `;
    html += `SET @ID2 = "${productIds[1]}" `;
    html += `SET @ID3 = "${productIds[2]}" `;
    html += `SET @ID4 = "${productIds[3]}" `;
    html += `SET @ID5 = "${productIds[4]}" `;
    html += `SET @ID6 = "${productIds[5]}" `;
    html += `SET @ID7 = "${productIds[6]}" `;
    html += `SET @ID8 = "${productIds[7]}" `;
    html += `SET @ID9 = "${productIds[8]}" `;
    html += `SET @ID10 = "${productIds[9]}" `;
    html += `SET @ID11 = "${productIds[10]}" `;
    html += `SET @ID12 = "${productIds[11]}" `;
    html += `SET @ID13 = "${productIds[12]}" `;
    html += `SET @ID14 = "${productIds[13]}" `;
    html += `SET @ID15 = "${productIds[14]}" `;
    html += `SET @ID16 = "${productIds[15]}" `;
    html += `SET @ID17 = "${productIds[16]}" `;
    html += `SET @ID18 = "${productIds[17]}" `;
    html += `SET @AliasRaptorProduct = CONCAT('Raptorfeed_manual', @feedtracking) `;
    html += `SET @account = lookup("Raptor_Configuration","Raptor Account ID","Locale",@locale) `;
    html += `SET @IDS = Concat(@ID1,",",@ID2,",",@ID3,",",@ID4,",",@ID5,",",@ID6,",",@ID7,",",@ID8,",",@ID9,",",@ID10,",",@ID11,",",@ID12,",",@ID13,",",@ID15,",",@ID15,",",@ID16,",",@ID17,",",@ID18) `;
    html += `SET @baseURL = Concat("https://mailmerge.raptorsmartadvisor.com/GetImagesByProductIds/", @account, "/dk/", @layout, "/") `;
    html += `SET @productQuery = Concat(".jpg?productIds=", @IDS) `;
    
    html += `FOR @row = 1 TO @prodRows DO `;
    html += `SET @img1 = Concat(@baseURL, Add(Multiply(Subtract(@row, 1),2), 1), @productQuery) `;
    html += `SET @url1 = Concat(@img1, "&redir=true") `;
    html += `SET @img2 = Concat(@baseURL, Add(Multiply(Subtract(@row, 1), 2), 2), @productQuery) `;
    html += `SET @url2 = Concat(@img2, "&redir=true") `;
    html += `]%% `;
    html += `%%=ContentBlockbyID("158017")=%%`;
    html += ` %%[ `;
    html += `NEXT @row`;
    html += `]%% `;
    
 
    sdk.setData({
      rows,
      layout,
      feedtracking,
      productIds
    });
    

      // Use setContent to save the HTML content
      sdk.setContent(html);

      // Use setSuperContent to show what is shown in the editor until a preview is generated
      const preview = '<img src="https://github.com/nikosjure/democontentblock/blob/main/blockimage.png?raw=true" alt="" width="590" style="display: block; padding: 0px; text-align: center; border: 0px solid transparent; height: auto; width: 100%;">'
      sdk.setSuperContent(preview);



    }

    // Initial setup of rows
    updateIDFields();
    
  </script>
</body>
</html>
